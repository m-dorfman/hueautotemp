"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.createUpdaterFn = exports.createTemperatureCycleFn = exports.createModelGeneratorFn = void 0;
const aws_cdk_lib_1 = require("aws-cdk-lib");
const aws_cdk_lib_2 = require("aws-cdk-lib");
const aws_cdk_lib_3 = require("aws-cdk-lib");
const utils_1 = require("./utils");
function createModelGeneratorFn(scope, temperatureCycleFn, modelGeneratorFnModuleName, modelBucket) {
    const modelGeneratorFn = new aws_cdk_lib_1.aws_lambda.Function(scope, 'ModelGeneratorFn', {
        description: 'Generates a model and serializes it for the temperature cycle funct',
        runtime: aws_cdk_lib_1.aws_lambda.Runtime.PYTHON_3_8,
        handler: `${modelGeneratorFnModuleName}.lambda_handler`,
        code: aws_cdk_lib_1.aws_lambda.Code.fromAsset((0, utils_1.getLambdaCodePath)(modelGeneratorFnModuleName)),
        environment: {
            "CALLER_FUNCTION_NAME": temperatureCycleFn.functionName,
            "MODEL_BUCKET_NAME": modelBucket.bucketName,
            "MODEL_OBJECT_KEY_ENV_VAR": "MODEL_OBJECT_KEY", // this is the env var key from the temperature fn
        },
    });
    modelGeneratorFn.addToRolePolicy(new aws_cdk_lib_2.aws_iam.PolicyStatement({
        actions: ['s3:PutObject',],
        resources: [modelBucket.bucketArn,]
    }));
    modelGeneratorFn.addToRolePolicy(new aws_cdk_lib_2.aws_iam.PolicyStatement({
        actions: ['lambda:UpdateFunctionConfiguration',],
        resources: [temperatureCycleFn.functionArn,]
    }));
    return modelGeneratorFn;
}
exports.createModelGeneratorFn = createModelGeneratorFn;
function createTemperatureCycleFn(scope, webParams, modelBucket, temperatureFnModuleName, lightGroup, cronTriggerEvent) {
    const temperatureCycleFn = new aws_cdk_lib_1.aws_lambda.Function(scope, 'TemperatureCycleFn', {
        description: 'Sends request to Hue device(s) to set light temperature',
        runtime: aws_cdk_lib_1.aws_lambda.Runtime.PYTHON_3_8,
        handler: `${temperatureFnModuleName}.lambda_handler`,
        code: aws_cdk_lib_1.aws_lambda.Code.fromAsset((0, utils_1.getLambdaCodePath)(temperatureFnModuleName)),
        environment: {
            "API_KEY_SSM_PARAM": webParams.hueApiKey.parameterName,
            "ADDRESS": webParams.address,
            "MODEL_BUCKET_NAME": modelBucket.bucketName,
            "MODEL_OBJECT_KEY": '',
            "LIGHT_GROUP": lightGroup,
        },
    });
    cronTriggerEvent.addTarget(new aws_cdk_lib_3.aws_events_targets.LambdaFunction(temperatureCycleFn));
    aws_cdk_lib_3.aws_events_targets.addLambdaPermission(cronTriggerEvent, temperatureCycleFn);
    temperatureCycleFn.addToRolePolicy(new aws_cdk_lib_2.aws_iam.PolicyStatement({
        actions: ['s3:GetObject',],
        resources: [modelBucket.bucketArn,]
    }));
    temperatureCycleFn.addToRolePolicy(new aws_cdk_lib_2.aws_iam.PolicyStatement({
        actions: ['ssm:GetParameter',],
        resources: [webParams.hueApiKey.parameterArn,]
    }));
    return temperatureCycleFn;
}
exports.createTemperatureCycleFn = createTemperatureCycleFn;
function createUpdaterFn(scope, webParams, cronTriggerEvent, updaterFnModuleName, writeQueue) {
    const updaterFn = new aws_cdk_lib_1.aws_lambda.Function(scope, 'UpdaterFn', {
        description: 'Performs updating functions upon light actions',
        runtime: aws_cdk_lib_1.aws_lambda.Runtime.PYTHON_3_8,
        handler: `${updaterFnModuleName}.lambda_handler`,
        code: aws_cdk_lib_1.aws_lambda.Code.fromAsset((0, utils_1.getLambdaCodePath)(updaterFnModuleName)),
        environment: {
            "API_KEY_SSM_PARAM": webParams.hueApiKey.parameterName,
            "ADDRESS": webParams.address,
            "CRON_EVENT_NAME": cronTriggerEvent.ruleName,
        },
    });
    if (typeof writeQueue !== 'undefined') {
        updaterFn.addEnvironment("WRITE_QUEUE_NAME", writeQueue.queueName);
        updaterFn.addToRolePolicy(new aws_cdk_lib_2.aws_iam.PolicyStatement({
            actions: ['sqs:SendMessage', 'sqs:GetQueueAttributes', 'sqs:GetQueueUrl',],
            resources: [writeQueue.queueArn,]
        }));
    }
    else {
        updaterFn.addEnvironment("WRITE_QUEUE_NAME", '');
    }
    updaterFn.addToRolePolicy(new aws_cdk_lib_2.aws_iam.PolicyStatement({
        actions: ['ssm:GetParameter',],
        resources: [webParams.hueApiKey.parameterArn,]
    }));
    updaterFn.addToRolePolicy(new aws_cdk_lib_2.aws_iam.PolicyStatement({
        actions: ['events:DisableRule', 'events:EnableRule',],
        resources: [cronTriggerEvent.ruleArn,]
    }));
    return updaterFn;
}
exports.createUpdaterFn = createUpdaterFn;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZnVuY3Rpb25zLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiZnVuY3Rpb25zLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7OztBQUFBLDZDQUFtRDtBQUNuRCw2Q0FBNkM7QUFLN0MsNkNBQTREO0FBRzVELG1DQUF5QztBQU96QyxTQUFnQixzQkFBc0IsQ0FDbEMsS0FBZ0IsRUFBRSxrQkFBbUMsRUFDckQsMEJBQWtDLEVBQUUsV0FBc0I7SUFFNUQsTUFBTSxnQkFBZ0IsR0FBRyxJQUFJLHdCQUFNLENBQUMsUUFBUSxDQUFDLEtBQUssRUFBRSxrQkFBa0IsRUFBRTtRQUN0RSxXQUFXLEVBQUUscUVBQXFFO1FBQ2xGLE9BQU8sRUFBRSx3QkFBTSxDQUFDLE9BQU8sQ0FBQyxVQUFVO1FBQ2xDLE9BQU8sRUFBRSxHQUFHLDBCQUEwQixpQkFBaUI7UUFDdkQsSUFBSSxFQUFFLHdCQUFNLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxJQUFBLHlCQUFpQixFQUFDLDBCQUEwQixDQUFDLENBQUM7UUFDMUUsV0FBVyxFQUFFO1lBQ1gsc0JBQXNCLEVBQUUsa0JBQWtCLENBQUMsWUFBWTtZQUN2RCxtQkFBbUIsRUFBRSxXQUFXLENBQUMsVUFBVTtZQUMzQywwQkFBMEIsRUFBRSxrQkFBa0IsRUFBRSxrREFBa0Q7U0FDbkc7S0FDRixDQUFDLENBQUM7SUFFSixnQkFBZ0IsQ0FBQyxlQUFlLENBQUMsSUFBSSxxQkFBRyxDQUFDLGVBQWUsQ0FBQztRQUN2RCxPQUFPLEVBQUUsQ0FBQyxjQUFjLEVBQUU7UUFDMUIsU0FBUyxFQUFDLENBQUMsV0FBVyxDQUFDLFNBQVMsRUFBRTtLQUNuQyxDQUFDLENBQUMsQ0FBQztJQUNKLGdCQUFnQixDQUFDLGVBQWUsQ0FBQyxJQUFJLHFCQUFHLENBQUMsZUFBZSxDQUFDO1FBQ3ZELE9BQU8sRUFBRSxDQUFDLG9DQUFvQyxFQUFFO1FBQ2hELFNBQVMsRUFBRSxDQUFDLGtCQUFrQixDQUFDLFdBQVcsRUFBRTtLQUM3QyxDQUFD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LENBQUM7S0FDTDtTQUFNO1FBQ0wsU0FBUyxDQUFDLGNBQWMsQ0FBQyxrQkFBa0IsRUFBRSxFQUFFLENBQUMsQ0FBQTtLQUNqRDtJQUNELFNBQVMsQ0FBQyxlQUFlLENBQUMsSUFBSSxxQkFBRyxDQUFDLGVBQWUsQ0FBQztRQUNoRCxPQUFPLEVBQUUsQ0FBQyxrQkFBa0IsRUFBRTtRQUM5QixTQUFTLEVBQUUsQ0FBQyxTQUFTLENBQUMsU0FBUyxDQUFDLFlBQVksRUFBRTtLQUMvQyxDQUFDLENBQUMsQ0FBQztJQUNKLFNBQVMsQ0FBQyxlQUFlLENBQUMsSUFBSSxxQkFBRyxDQUFDLGVBQWUsQ0FBQztRQUNoRCxPQUFPLEVBQUUsQ0FBQyxvQkFBb0IsRUFBRSxtQkFBbUIsRUFBRTtRQUNyRCxTQUFTLEVBQUUsQ0FBQyxnQkFBZ0IsQ0FBQyxPQUFPLEVBQUU7S0FDdkMsQ0FBQyxDQUFDLENBQUM7SUFFSixPQUFPLFNBQVMsQ0FBQztBQUNuQixDQUFDO0FBbkNELDBDQW1DQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IGF3c19sYW1iZGEgYXMgbGFtYmRhIH0gZnJvbSBcImF3cy1jZGstbGliXCI7XG5pbXBvcnQgeyBhd3NfaWFtIGFzIGlhbSB9IGZyb20gXCJhd3MtY2RrLWxpYlwiO1xuaW1wb3J0IHsgYXdzX3NucyBhcyBzbnMgfSBmcm9tIFwiYXdzLWNkay1saWJcIjtcbmltcG9ydCB7IGF3c19zcXMgYXMgc3FzIH0gZnJvbSBcImF3cy1jZGstbGliXCI7XG5pbXBvcnQgeyBhd3NfczMgYXMgczN9IGZyb20gXCJhd3MtY2RrLWxpYlwiO1xuaW1wb3J0IHsgYXdzX3NzbSBhcyBzc20gfSBmcm9tIFwiYXdzLWNkay1saWJcIjtcbmltcG9ydCB7IGF3c19ldmVudHNfdGFyZ2V0cyBhcyB0YXJnZXRzIH0gZnJvbSBcImF3cy1jZGstbGliXCI7XG5pbXBvcnQgeyBhd3NfZXZlbnRzIGFzIGV2ZW50cyB9IGZyb20gXCJhd3MtY2RrLWxpYlwiO1xuaW1wb3J0IHtDb25zdHJ1Y3R9IGZyb20gXCJjb25zdHJ1Y3RzXCI7XG5pbXBvcnQge2dldExhbWJkYUNvZGVQYXRofSBmcm9tICcuL3V0aWxzJ1xuXG5leHBvcnQgaW50ZXJmYWNlIFdlYlBhcmFtcyB7XG4gIGFkZHJlc3M6IHN0cmluZyxcbiAgaHVlQXBpS2V5OiBzc20uU3RyaW5nUGFyYW1ldGVyLFxufVxuXG5leHBvcnQgZnVuY3Rpb24gY3JlYXRlTW9kZWxHZW5lcmF0b3JGbihcbiAgICBzY29wZTogQ29uc3RydWN0LCB0ZW1wZXJhdHVyZUN5Y2xlRm46IGxhbWJkYS5GdW5jdGlvbixcbiAgICBtb2RlbEdlbmVyYXRvckZuTW9kdWxlTmFtZTogc3RyaW5nLCBtb2RlbEJ1Y2tldDogczMuQnVja2V0LFxuKSB7XG4gIGNvbnN0IG1vZGVsR2VuZXJhdG9yRm4gPSBuZXcgbGFtYmRhLkZ1bmN0aW9uKHNjb3BlLCAnTW9kZWxHZW5lcmF0b3JGbicsIHtcbiAgICBkZXNjcmlwdGlvbjogJ0dlbmVyYXRlcyBhIG1vZGVsIGFuZCBzZXJpYWxpemVzIGl0IGZvciB0aGUgdGVtcGVyYXR1cmUgY3ljbGUgZnVuY3QnLFxuICAgIHJ1bnRpbWU6IGxhbWJkYS5SdW50aW1lLlBZVEhPTl8zXzgsXG4gICAgaGFuZGxlcjogYCR7bW9kZWxHZW5lcmF0b3JGbk1vZHVsZU5hbWV9LmxhbWJkYV9oYW5kbGVyYCxcbiAgICBjb2RlOiBsYW1iZGEuQ29kZS5mcm9tQXNzZXQoZ2V0TGFtYmRhQ29kZVBhdGgobW9kZWxHZW5lcmF0b3JGbk1vZHVsZU5hbWUpKSxcbiAgICBlbnZpcm9ubWVudDoge1xuICAgICAgXCJDQUxMRVJfRlVOQ1RJT05fTkFNRVwiOiB0ZW1wZXJhdHVyZUN5Y2xlRm4uZnVuY3Rpb25OYW1lLFxuICAgICAgXCJNT0RFTF9CVUNLRVRfTkFNRVwiOiBtb2RlbEJ1Y2tldC5idWNrZXROYW1lLFxuICAgICAgXCJNT0RFTF9PQkpFQ1RfS0VZX0VOVl9WQVJcIjogXCJNT0RFTF9PQkpFQ1RfS0VZXCIsIC8vIHRoaXMgaXMgdGhlIGVudiB2YXIga2V5IGZyb20gdGhlIHRlbXBlcmF0dXJlIGZuXG4gICAgfSxcbiAgfSk7XG5cbiBtb2RlbEdlbmVyYXRvckZuLmFkZFRvUm9sZVBvbGljeShuZXcgaWFtLlBvbGljeVN0YXRlbWVudCh7XG4gICBhY3Rpb25zOiBbJ3MzOlB1dE9iamVjdCcsXSxcbiAgIHJlc291cmNlczpbbW9kZWxCdWNrZXQuYnVja2V0QXJuLF1cbiB9KSk7XG4gbW9kZWxHZW5lcmF0b3JGbi5hZGRUb1JvbGVQb2xpY3kobmV3IGlhbS5Qb2xpY3lTdGF0ZW1lbnQoe1xuICAgYWN0aW9uczogWydsYW1iZGE6VXBkYXRlRnVuY3Rpb25Db25maWd1cmF0aW9uJyxdLFxuICAgcmVzb3VyY2VzOiBbdGVtcGVyYXR1cmVDeWNsZUZuLmZ1bmN0aW9uQXJuLF1cbiB9KSk7XG5cbiByZXR1cm4gbW9kZWxHZW5lcmF0b3JGblxufVxuXG5leHBvcnQgZnVuY3Rpb24gY3JlYXRlVGVtcGVyYXR1cmVDeWNsZUZuKFxuICAgIHNjb3BlOkNvbnN0cnVjdCwgd2ViUGFyYW1zOiBXZWJQYXJhbXMsXG4gICAgbW9kZWxCdWNrZXQ6IHMzLkJ1Y2tldCwgdGVtcGVyYXR1cmVGbk1vZHVsZU5hbWU6IHN0cmluZyxcbiAgICBsaWdodEdyb3VwOiBzdHJpbmcsIGNyb25UcmlnZ2VyRXZlbnQ6IGV2ZW50cy5SdWxlLFxuKSB7XG4gIGNvbnN0IHRlbXBlcmF0dXJlQ3ljbGVGbiA9IG5ldyBsYW1iZGEuRnVuY3Rpb24oc2NvcGUsICdUZW1wZXJhdHVyZUN5Y2xlRm4nLCB7XG4gICAgZGVzY3JpcHRpb246ICdTZW5kcyByZXF1ZXN0IHRvIEh1ZSBkZXZpY2UocykgdG8gc2V0IGxpZ2h0IHRlbXBlcmF0dXJlJyxcbiAgICBydW50aW1lOiBsYW1iZGEuUnVudGltZS5QWVRIT05fM184LFxuICAgIGhhbmRsZXI6IGAke3RlbXBlcmF0dXJlRm5Nb2R1bGVOYW1lfS5sYW1iZGFfaGFuZGxlcmAsXG4gICAgY29kZTogbGFtYmRhLkNvZGUuZnJvbUFzc2V0KGdldExhbWJkYUNvZGVQYXRoKHRlbXBlcmF0dXJlRm5Nb2R1bGVOYW1lKSksXG4gICAgZW52aXJvbm1lbnQ6IHtcbiAgICAgIFwiQVBJX0tFWV9TU01fUEFSQU1cIjogd2ViUGFyYW1zLmh1ZUFwaUtleS5wYXJhbWV0ZXJOYW1lLFxuICAgICAgXCJBRERSRVNTXCI6IHdlYlBhcmFtcy5hZGRyZXNzLFxuICAgICAgXCJNT0RFTF9CVUNLRVRfTkFNRVwiOiBtb2RlbEJ1Y2tldC5idWNrZXROYW1lLFxuICAgICAgXCJNT0RFTF9PQkpFQ1RfS0VZXCI6ICcnLFxuICAgICAgXCJMSUdIVF9HUk9VUFwiOiBsaWdodEdyb3VwLFxuICAgIH0sXG4gIH0pO1xuXG4gIGNyb25UcmlnZ2VyRXZlbnQuYWRkVGFyZ2V0KG5ldyB0YXJnZXRzLkxhbWJkYUZ1bmN0aW9uKHRlbXBlcmF0dXJlQ3ljbGVGbikpO1xuICB0YXJnZXRzLmFkZExhbWJkYVBlcm1pc3Npb24oY3JvblRyaWdnZXJFdmVudCwgdGVtcGVyYXR1cmVDeWNsZUZuKTtcblxuICB0ZW1wZXJhdHVyZUN5Y2xlRm4uYWRkVG9Sb2xlUG9saWN5KG5ldyBpYW0uUG9saWN5U3RhdGVtZW50KHtcbiAgICBhY3Rpb25zOiBbJ3MzOkdldE9iamVjdCcsXSxcbiAgICByZXNvdXJjZXM6IFttb2RlbEJ1Y2tldC5idWNrZXRBcm4sXVxuICB9KSk7XG4gIHRlbXBlcmF0dXJlQ3ljbGVGbi5hZGRUb1JvbGVQb2xpY3kobmV3IGlhbS5Qb2xpY3lTdGF0ZW1lbnQoe1xuICAgIGFjdGlvbnM6IFsnc3NtOkdldFBhcmFtZXRlcicsXSxcbiAgICByZXNvdXJjZXM6IFt3ZWJQYXJhbXMuaHVlQXBpS2V5LnBhcmFtZXRlckFybixdXG4gIH0pKTtcblxuICByZXR1cm4gdGVtcGVyYXR1cmVDeWNsZUZuO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gY3JlYXRlVXBkYXRlckZuKFxuICAgIHNjb3BlOiBDb25zdHJ1Y3QsIHdlYlBhcmFtczogV2ViUGFyYW1zLFxuICAgIGNyb25UcmlnZ2VyRXZlbnQ6IGV2ZW50cy5SdWxlLCAgdXBkYXRlckZuTW9kdWxlTmFtZTogc3RyaW5nLFxuICAgIHdyaXRlUXVldWU/OiBzcXMuUXVldWUsXG4pIHtcbiAgY29uc3QgdXBkYXRlckZuID0gbmV3IGxhbWJkYS5GdW5jdGlvbihzY29wZSwgJ1VwZGF0ZXJGbicsIHtcbiAgICBkZXNjcmlwdGlvbjogJ1BlcmZvcm1zIHVwZGF0aW5nIGZ1bmN0aW9ucyB1cG9uIGxpZ2h0IGFjdGlvbnMnLFxuICAgIHJ1bnRpbWU6IGxhbWJkYS5SdW50aW1lLlBZVEhPTl8zXzgsXG4gICAgaGFuZGxlcjogYCR7dXBkYXRlckZuTW9kdWxlTmFtZX0ubGFtYmRhX2hhbmRsZXJgLFxuICAgIGNvZGU6IGxhbWJkYS5Db2RlLmZyb21Bc3NldChnZXRMYW1iZGFDb2RlUGF0aCh1cGRhdGVyRm5Nb2R1bGVOYW1lKSksXG4gICAgZW52aXJvbm1lbnQ6IHtcbiAgICAgIFwiQVBJX0tFWV9TU01fUEFSQU1cIjogd2ViUGFyYW1zLmh1ZUFwaUtleS5wYXJhbWV0ZXJOYW1lLFxuICAgICAgXCJBRERSRVNTXCI6IHdlYlBhcmFtcy5hZGRyZXNzLFxuICAgICAgXCJDUk9OX0VWRU5UX05BTUVcIjogY3JvblRyaWdnZXJFdmVudC5ydWxlTmFtZSxcbiAgICB9LFxuICB9KTtcbiAgaWYgKHR5cGVvZiB3cml0ZVF1ZXVlICE9PSAndW5kZWZpbmVkJykge1xuICAgIHVwZGF0ZXJGbi5hZGRFbnZpcm9ubWVudChcIldSSVRFX1FVRVVFX05BTUVcIiwgd3JpdGVRdWV1ZS5xdWV1ZU5hbWUpO1xuICAgIHVwZGF0ZXJGbi5hZGRUb1JvbGVQb2xpY3kobmV3IGlhbS5Qb2xpY3lTdGF0ZW1lbnQoe1xuICAgICAgYWN0aW9uczogWydzcXM6U2VuZE1lc3NhZ2UnLCAnc3FzOkdldFF1ZXVlQXR0cmlidXRlcycsICdzcXM6R2V0UXVldWVVcmwnLF0sXG4gICAgICByZXNvdXJjZXM6IFt3cml0ZVF1ZXVlLnF1ZXVlQXJuLF1cbiAgICB9KSk7XG4gIH0gZWxzZSB7XG4gICAgdXBkYXRlckZuLmFkZEVudmlyb25tZW50KFwiV1JJVEVfUVVFVUVfTkFNRVwiLCAnJylcbiAgfVxuICB1cGRhdGVyRm4uYWRkVG9Sb2xlUG9saWN5KG5ldyBpYW0uUG9saWN5U3RhdGVtZW50KHtcbiAgICBhY3Rpb25zOiBbJ3NzbTpHZXRQYXJhbWV0ZXInLF0sXG4gICAgcmVzb3VyY2VzOiBbd2ViUGFyYW1zLmh1ZUFwaUtleS5wYXJhbWV0ZXJBcm4sXVxuICB9KSk7XG4gIHVwZGF0ZXJGbi5hZGRUb1JvbGVQb2xpY3kobmV3IGlhbS5Qb2xpY3lTdGF0ZW1lbnQoe1xuICAgIGFjdGlvbnM6IFsnZXZlbnRzOkRpc2FibGVSdWxlJywgJ2V2ZW50czpFbmFibGVSdWxlJyxdLFxuICAgIHJlc291cmNlczogW2Nyb25UcmlnZ2VyRXZlbnQucnVsZUFybixdXG4gIH0pKTtcblxuICByZXR1cm4gdXBkYXRlckZuO1xufSJdfQ==